pipeline {
    agent any

    options {
        buildDiscarder(logRotator(numToKeepStr: '5'))
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'master',
                    url: 'https://github.com/Vinicius-Chagas/Pratica6.git'
            }
        }

        stage('Build, Test & Verify') {
            steps {
                script {
                    // O comando 'verify' é essencial aqui.
                    // Ele executa: Compilação -> Testes -> JaCoCo Report -> JaCoCo Check (Quality Gate do pom.xml) -> PMD
                    // Suporte para Windows e Linux
                    if (isUnix()) {
                        sh 'mvn clean install'
                    } else {
                        bat 'mvn clean install'
                    }
                }
            }
        }
    }

    post {
        always {
            // 1. Relatório de Testes (JUnit)
            junit '**/target/surefire-reports/*.xml'

            // 2. Relatório de Cobertura (JaCoCo)
            // Substituindo o plugin antigo 'jacoco' pelo 'recordCoverage' para visualização moderna e Quality Gate no Jenkins.
            // O pom.xml gera o relatório em target/site/jacoco/jacoco.xml durante a fase 'test'/'verify'.
            recordCoverage(
                tools: [[parser: 'JACOCO', pattern: '**/target/site/jacoco/jacoco.xml']],
                qualityGates: [
                    [threshold: 99.0, metric: 'LINE', baseline: 'PROJECT', criticality: 'UNSTABLE']
                ]
            )

            // 3. Análise Estática (PMD)
            recordIssues(
                enabledForFailure: true,
                tools: [pmdParser(pattern: '**/target/pmd.xml')]
            )
        }

        success {
            // Só executa se o build for estável (SUCCESS)
            build job: 'Image_Docker_AC2', wait: false
        }
    }
}
