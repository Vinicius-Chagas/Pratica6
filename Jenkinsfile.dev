pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                git branch: 'master',
                    url: 'https://github.com/Vinicius-Chagas/Pratica6.git'
            }
        }

        stage('Build, Test & Verify') {
            steps {
                // O comando 'verify' é essencial aqui.
                // Ele executa: Compilação -> Testes -> JaCoCo Report -> JaCoCo Check (Quality Gate do pom.xml) -> PMD
                sh 'mvn clean install'
            }
        }
    }

    post {
        always {
            // 1. Relatório de Testes (JUnit)
            junit '**/target/surefire-reports/*.xml'

            // 2. Relatório de Cobertura (JaCoCo)
            // A validação de 99% já foi feita pelo Maven acima.
            // Este passo aqui serve apenas para gerar o gráfico no painel do Jenkins.
            jacoco(
                execPattern: '**/target/jacoco.exec',
                classPattern: '**/target/classes',
                sourcePattern: '**/src/main/java',
                inclusionPattern: '**/*.class'
            )

            // 3. Análise Estática (PMD)
            recordIssues(
                enabledForFailure: true,
                tools: [pmdParser(pattern: '**/target/pmd.xml')]
            )
        }

        success {
            // Só executa se o Maven não falhar (ou seja, se cobertura >= 99%)
            build job: 'Image_Docker_AC2', wait: false
        }
    }
}
